<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Viewer - D√©tection Target</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .ar-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            max-width: 300px;
        }

        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f87171;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 1000;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .error-message {
            font-size: 1rem;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .retry-btn {
            background: white;
            color: #f87171;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            color: white;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .camera-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .target-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            color: white;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .target-info.visible {
            transform: translateY(0);
        }

        .target-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .target-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .ar-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
            z-index: 50;
        }

        .instructions-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- √âcran de chargement -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initialisation AR...</div>
        <div class="loading-subtitle">Chargement de la cam√©ra et des librairies AR</div>
    </div>

    <!-- √âcran d'erreur -->
    <div id="errorScreen" class="error-screen hidden">
        <div class="error-icon">‚ùå</div>
        <div class="error-title">Erreur AR</div>
        <div id="errorMessage" class="error-message">Une erreur est survenue</div>
        <button class="retry-btn" onclick="location.reload()">üîÑ R√©essayer</button>
    </div>

    <!-- Interface AR -->
    <div class="ar-container">
        <!-- Contr√¥les -->
        <div class="controls">
            <div class="status-info">
                <div class="status-dot"></div>
                <span id="statusText">AR actif - Recherche de target...</span>
            </div>
            <button class="camera-btn" onclick="switchCamera()">üì∑ Changer cam√©ra</button>
        </div>

        <!-- Instructions -->
        <div id="instructions" class="instructions">
            <div class="instructions-icon">üéØ</div>
            <h3>Pointez votre cam√©ra vers l'image target</h3>
            <p>L'objet AR appara√Ætra automatiquement quand la target sera d√©tect√©e</p>
        </div>

        <!-- Informations target -->
        <div id="targetInfo" class="target-info">
            <div id="targetName" class="target-name">Target d√©tect√©e</div>
            <div id="targetDetails" class="target-details">Informations sur la target</div>
        </div>

        <!-- Contenu AR -->
        <div class="ar-content">
            <a-scene
                id="arScene"
                embedded
                arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
                vr-mode-ui="enabled: false"
                gesture-detector
                artoolkit-scene>
                
                <!-- Curseur cam√©ra -->
                <a-camera
                    id="arCamera"
                    gps-camera
                    rotation-reader
                    look-controls="enabled: false"
                    arjs-look-controls="smoothingFactor: 0.1">
                </a-camera>

                <!-- Marker dynamique qui sera cr√©√© par JavaScript -->
                <a-marker
                    id="dynamicMarker"
                    type="pattern"
                    url=""
                    smooth="true"
                    smoothCount="10"
                    smoothTolerance="0.01"
                    smoothThreshold="5"
                    raycaster="objects: .clickable"
                    emitevents="true"
                    cursor="fuse: false; rayOrigin: mouse">
                    
                    <!-- Contenu AR par d√©faut -->
                    <a-box
                        id="arBox"
                        position="0 0.5 0"
                        material="color: #4f46e5; metalness: 0.5; roughness: 0.3"
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
                        gesture-handler="minScale: 0.25; maxScale: 10"
                        class="clickable">
                    </a-box>
                    
                    <a-text
                        value="Target d√©tect√©e !"
                        position="0 2 0"
                        align="center"
                        color="#ffffff"
                        background="color: rgba(0,0,0,0.8); opacity: 0.8"
                        geometry="primitive: plane; width: 3; height: 0.8">
                    </a-text>
                </a-marker>
            </a-scene>
        </div>
    </div>

    <!-- AR.js et A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="AR.js-master/aframe/build/aframe-ar.js"></script>
    
    <script>
        // Variables globales
        let targetData = null;
        let targetId = null;
        let isARReady = false;
        let isTargetVisible = false;
        let currentCamera = 'environment';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeAR();
        });

        function initializeAR() {
            try {
                // Extraire l'ID de la target depuis l'URL
                const urlParams = new URLSearchParams(window.location.search);
                targetId = urlParams.get('target');

                if (!targetId) {
                    showError('ID de target manquant', 'Aucun identifiant de target trouv√© dans l\'URL');
                    return;
                }

                // Charger les donn√©es de la target
                loadTargetData();

            } catch (error) {
                console.error('Erreur initialisation AR:', error);
                showError('Erreur d\'initialisation', error.message);
            }
        }

        function loadTargetData() {
            try {
                const stored = localStorage.getItem(`ar_target_${targetId}`);
                
                if (!stored) {
                    showError('Target introuvable', 'Les donn√©es de cette target n\'ont pas √©t√© trouv√©es. Le QR code est peut-√™tre expir√©.');
                    return;
                }

                targetData = JSON.parse(stored);
                console.log('Target charg√©e:', targetData);

                // Cr√©er le pattern NFT √† partir de l'image
                setupNFTMarker();

            } catch (error) {
                console.error('Erreur chargement target:', error);
                showError('Erreur de chargement', 'Impossible de charger les donn√©es de la target');
            }
        }

        function setupNFTMarker() {
            try {
                // Convertir l'image en pattern pour AR.js
                const markerEl = document.getElementById('dynamicMarker');
                
                // Configurer le marker avec l'image target
                markerEl.setAttribute('type', 'pattern');
                markerEl.setAttribute('url', createPatternFromImage(targetData.data));
                
                // Mettre √† jour les informations
                updateTargetInfo();
                
                // Ajouter les √©v√©nements de d√©tection
                setupMarkerEvents();
                
                // AR pr√™t
                setTimeout(() => {
                    hideLoading();
                    isARReady = true;
                    updateStatus('AR pr√™t - Recherche de target...');
                }, 2000);

            } catch (error) {
                console.error('Erreur setup marker:', error);
                showError('Erreur configuration AR', 'Impossible de configurer le marker AR');
            }
        }

        function createPatternFromImage(imageData) {
            // Pour une d√©monstration, on utilise un pattern par d√©faut d'AR.js
            // Dans une impl√©mentation compl√®te, il faudrait g√©n√©rer un pattern √† partir de l'image
            // ou utiliser NFT (Natural Feature Tracking)
            return 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt';
        }

        function setupMarkerEvents() {
            const markerEl = document.getElementById('dynamicMarker');
            
            markerEl.addEventListener('markerFound', function() {
                console.log('Target trouv√©e !');
                isTargetVisible = true;
                showTargetInfo();
                hideInstructions();
                updateStatus('Target d√©tect√©e !');
            });

            markerEl.addEventListener('markerLost', function() {
                console.log('Target perdue');
                isTargetVisible = false;
                hideTargetInfo();
                showInstructions();
                updateStatus('AR actif - Recherche de target...');
            });
        }

        function updateTargetInfo() {
            if (!targetData) return;

            document.getElementById('targetName').textContent = targetData.name;
            document.getElementById('targetDetails').innerHTML = `
                R√©solution: ${targetData.width}x${targetData.height}px<br>
                Cr√©√©e le: ${new Date(targetData.created).toLocaleDateString('fr-FR')}
            `;
        }

        function showTargetInfo() {
            document.getElementById('targetInfo').classList.add('visible');
        }

        function hideTargetInfo() {
            document.getElementById('targetInfo').classList.remove('visible');
        }

        function showInstructions() {
            document.getElementById('instructions').classList.remove('hidden');
        }

        function hideInstructions() {
            document.getElementById('instructions').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showError(title, message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function switchCamera() {
            // Cette fonction permettrait de changer entre cam√©ra avant/arri√®re
            // Implementation d√©pendante du device et des capacit√©s AR.js
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            updateStatus(`Cam√©ra: ${currentCamera === 'environment' ? 'Arri√®re' : 'Avant'}`);
        }

        // Gestion des erreurs AR.js
        window.addEventListener('arjs-video-loaded', function() {
            console.log('‚úÖ Vid√©o AR.js charg√©e');
        });

        window.addEventListener('camera-error', function(error) {
            console.error('‚ùå Erreur cam√©ra:', error);
            showError('Erreur cam√©ra', 'Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.');
        });

        // Gestion des gestures sur mobile
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
            },

            init: function () {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    this.isVisible = true;
                });

                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    this.isVisible = false;
                });
            },

            listeners: {
                onefingermove: function (event) {
                    if (this.isVisible) {
                        this.handleRotation(event);
                    }
                },

                twofingermove: function (event) {
                    if (this.isVisible) {
                        this.handleScale(event);
                    }
                }
            },

            handleRotation: function (event) {
                if (this.data.enabled) {
                    this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                    this.el.object3D.rotation.x += event.detail.positionChange.y * this.data.rotationFactor;
                }
            },

            handleScale: function (event) {
                if (this.data.enabled) {
                    this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
                    this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);

                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            }
        });
    </script>
</body>
</html> 