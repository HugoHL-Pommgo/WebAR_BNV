<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebAR - Plante 3D</title>
  
  <!-- MindAR + A-Frame pour image tracking personnalis√©e -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    /* Correction pour Mozilla/Mac - Force le centrage complet */
    a-scene {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 1;
    }
    
    /* Canvas AR centr√© et responsive */
    canvas {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      width: auto !important;
      height: auto !important;
      object-fit: cover;
    }
    
    /* Fixes sp√©cifiques Mozilla */
    @-moz-document url-prefix() {
      canvas {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      a-scene {
        display: block !important;
        position: absolute !important;
      }
    }
    
    #startButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 999;
    }
    
    #instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      z-index: 998;
      font-size: 16px;
    }
    
    #detectionZone {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 180px;
      border: 2px solid rgba(255, 193, 7, 0.6);
      border-radius: 15px;
      z-index: 997;
      pointer-events: none;
      animation: guideAnimation 3s infinite;
    }
    
    #detectionZone::before {
      content: "";
      position: absolute;
      top: -8px;
      left: -8px;
      right: -8px;
      bottom: -8px;
      border: 1px dashed rgba(255, 193, 7, 0.3);
      border-radius: 20px;
    }
    
    #detectionZone::after {
      content: "üåª Pointez vers l'image de fleur";
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 193, 7, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
    }
    
    @keyframes guideAnimation {
      0% { 
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1);
      }
      50% { 
        opacity: 0.8;
        transform: translate(-50%, -50%) scale(1.05);
      }
      100% { 
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    #fullDetectionArea {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 3px solid rgba(255, 193, 7, 0.2);
      z-index: 996;
      pointer-events: none;
      animation: fullAreaPulse 4s infinite;
    }
    
    @keyframes fullAreaPulse {
      0%, 100% { border-color: rgba(255, 193, 7, 0.2); }
      50% { border-color: rgba(255, 193, 7, 0.4); }
    }
    
    #debugInfo {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 995;
    }
    
    /* Image target transparente comme guide */
    #targetGuide {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: auto;
      opacity: 0.3;
      border: 2px dashed rgba(255, 193, 7, 0.8);
      border-radius: 10px;
      z-index: 990;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    
    #targetGuide.detected {
      opacity: 0;
    }
    
    .hidden {
      display: none !important;
    }
    
    .detected {
      border-color: #FF9800 !important;
      animation: detectedGlow 1s infinite alternate !important;
    }
    
    .detected::after {
      content: "‚úÖ Fleur d√©tect√©e!" !important;
      background: rgba(255, 152, 0, 0.9) !important;
    }
    
    @keyframes detectedGlow {
      0% { box-shadow: 0 0 10px rgba(255, 152, 0, 0.6); }
      100% { box-shadow: 0 0 20px rgba(255, 152, 0, 0.9); }
    }
    
    .full-detection {
      border-color: rgba(255, 152, 0, 0.6) !important;
      animation: none !important;
    }
  </style>
</head>
<body>
  <button id="startButton" onclick="startAR()">üöÄ D√©marrer AR</button>
  
  <div id="instructions" class="hidden">
    üåª Pointez vers l'image de fleur jaune<br>
    Distance: 20-50cm ‚Ä¢ Bon √©clairage requis<br>
    <a href="flower-target.html" style="color: #FFC107; text-decoration: underline;">üìÑ Voir l'image cible</a>
  </div>

  <div id="detectionZone" class="hidden"></div>
  <div id="fullDetectionArea" class="hidden"></div>
  
  <!-- Image target transparente comme guide -->
  <img id="targetGuide" 
       src="./assets/quatre-sortes-fleurs-jaunes_1308-2129.jpg" 
       alt="Guide image target" 
       class="hidden">

  <div id="debugInfo" class="hidden">
    Status: Initialisation...<br>
    Type: Image de fleur
  </div>

  <a-scene 
    id="arScene"
    class="hidden"
    embedded
    mindar-image="imageTargetSrc: ./assets/targets.mind; 
                  maxTrack: 1; 
                  filterMinCF: 0.0001; 
                  filterBeta: 0.01; 
                  uiLoading: no; 
                  uiScanning: no; 
                  uiError: no;"
    color-space="sRGB" 
    renderer="colorManagement: true; physicallyCorrectLights; alpha: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <!-- Cam√©ra AR pour MindAR -->
    <a-camera 
      position="0 0 0"
      look-controls="enabled: false"
      cursor="fuse: false; rayOrigin: mouse;"
      raycaster="far: 10000; objects: .clickable">
    </a-camera>
    
    <!-- Assets avec chemins GitHub Pages -->
    <a-assets>
      <a-asset-item id="plantModel" src="./assets/topfpflanze_final.glb"></a-asset-item>
    </a-assets>
    
    <!-- √âclairage optimis√© pour image tracking -->
    <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
    <a-light type="directional" position="2 2 2" color="#ffffff" intensity="1.2"></a-light>
    <a-light type="point" position="0 2 0" color="#FFC107" intensity="0.4"></a-light>
    
    <!-- Anchor pour image target (index 0) -->
    <a-entity 
      id="flowerTarget"
      mindar-image-target="targetIndex: 0"
      visible="false">
      
      <!-- Mod√®le 3D de la plante -->
      <a-gltf-model
        id="plantModel3D"
        src="#plantModel"
        position="0 0 0"
        rotation="-90 0 0"
        scale="0.3 0.3 0.3"
        visible="true"
        animation__scale="property: scale; 
                         to: 0.35 0.35 0.35; 
                         dur: 2000; 
                         dir: alternate; 
                         loop: true; 
                         easing: easeInOutSine">
      </a-gltf-model>
      
      <!-- Indicateur circulaire autour de la plante -->
      <a-ring
        position="0 0.02 0"
        rotation="-90 0 0"
        radius-inner="0.7"
        radius-outer="0.9"
        color="#FFC107"
        opacity="0.6"
        id="flowerRing"
        animation="property: rotation; 
                   to: -90 360 0; 
                   loop: true; 
                   dur: 6000; 
                   easing: linear">
      </a-ring>
      
      <!-- Particules flottantes -->
      <a-sphere
        position="0.3 1 0.3"
        radius="0.03"
        color="#FFC107"
        opacity="0.8"
        animation="property: position; 
                   to: 0.3 1.5 0.3; 
                   loop: true; 
                   dur: 3000; 
                   dir: alternate; 
                   easing: easeInOutSine">
      </a-sphere>
      
      <a-sphere
        position="-0.2 1.2 -0.2"
        radius="0.025"
        color="#FFE082"
        opacity="0.7"
        animation="property: position; 
                   to: -0.2 1.8 -0.2; 
                   loop: true; 
                   dur: 4000; 
                   dir: alternate; 
                   easing: easeInOutSine">
      </a-sphere>
      
    </a-entity>
    
  </a-scene>

  <script>
    let flowerTarget;
    let debugInfo;
    let detectionZone;
    let fullDetectionArea;
    let targetGuide;
    let targetFound = false;
    let lastDetectionTime = 0;
    let cameraPermissionGranted = false;

    async function checkCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraPermissionGranted = true;
        console.log('‚úÖ Permission cam√©ra accord√©e');
        stream.getTracks().forEach(track => track.stop());
        return true;
      } catch (error) {
        console.error('‚ùå Erreur permission cam√©ra:', error);
        debugInfo.innerHTML = 'Status: ‚ùå Acc√®s cam√©ra refus√©<br>Cliquez sur üîí pour autoriser';
        debugInfo.style.background = 'rgba(244, 67, 54, 0.8)';
        return false;
      }
    }

    async function startAR() {
      document.getElementById('startButton').classList.add('hidden');
      document.getElementById('debugInfo').classList.remove('hidden');
      
      debugInfo = document.querySelector('#debugInfo');
      debugInfo.innerHTML = 'Status: üîç V√©rification cam√©ra...<br>Type: Image de fleur';
      
      // V√©rifier l'acc√®s cam√©ra d'abord
      const hasCamera = await checkCameraPermission();
      
      if (!hasCamera) {
        debugInfo.innerHTML = 'Status: ‚ö†Ô∏è Cam√©ra requise<br>üí° Autorisez dans les param√®tres';
        return;
      }
      
      // Si cam√©ra OK, d√©marrer l'AR
      document.getElementById('arScene').classList.remove('hidden');
      document.getElementById('instructions').classList.remove('hidden');
      document.getElementById('detectionZone').classList.remove('hidden');
      document.getElementById('fullDetectionArea').classList.remove('hidden');
      document.getElementById('targetGuide').classList.remove('hidden');
      
      debugInfo.innerHTML = 'Status: üöÄ Initialisation MindAR...<br>Type: Image de fleur';
      
      // Force le canvas √† se positionner correctement sur Mozilla
      setTimeout(() => {
        const canvas = document.querySelector('canvas');
        if (canvas && navigator.userAgent.includes('Firefox')) {
          canvas.style.position = 'absolute';
          canvas.style.top = '0';
          canvas.style.left = '0';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.transform = 'none';
        }
      }, 500);
      
      // Attendre que MindAR se charge
      setTimeout(() => {
        try {
          setupImageTracking();
        } catch (error) {
          console.error('Erreur d√©marrage AR:', error);
          debugInfo.innerHTML = 'Status: ‚ùå Erreur MindAR<br>Rechargez la page';
        }
      }, 2000);
    }

    function setupImageTracking() {
      flowerTarget = document.querySelector('#flowerTarget');
      detectionZone = document.querySelector('#detectionZone');
      fullDetectionArea = document.querySelector('#fullDetectionArea');
      targetGuide = document.querySelector('#targetGuide');
      
      debugInfo.innerHTML = 'Status: üåª Recherche image fleur...<br>Pointez vers l\'image';
      
      if (flowerTarget) {
        // √âv√©nements de d√©tection image
        flowerTarget.addEventListener('targetFound', function() {
          console.log('üåª Image de fleur d√©tect√©e!');
          targetFound = true;
          lastDetectionTime = Date.now();
          
          // Mise √† jour visuelle
          detectionZone.classList.add('detected');
          fullDetectionArea.classList.add('full-detection');
          targetGuide.classList.add('detected'); // Cache l'image guide
          debugInfo.innerHTML = 'Status: ‚úÖ FLEUR D√âTECT√âE!<br>Mod√®le 3D affich√©';
          debugInfo.style.background = 'rgba(255, 193, 7, 0.8)';
          
          // Feedback tactile
          if (navigator.vibrate) {
            navigator.vibrate([150, 100, 150, 100, 300]);
          }
        });

        flowerTarget.addEventListener('targetLost', function() {
          console.log('‚ùå Image de fleur perdue');
          targetFound = false;
          
          // Retour visuel normal
          detectionZone.classList.remove('detected');
          fullDetectionArea.classList.remove('full-detection');
          targetGuide.classList.remove('detected'); // R√©affiche l'image guide
          debugInfo.innerHTML = 'Status: üîç Recherche fleur...<br>Repositionnez l\'image';
          debugInfo.style.background = 'rgba(0,0,0,0.8)';
        });
      }
      
      // Mise √† jour dynamique du statut
      setInterval(() => {
        if (!targetFound && cameraPermissionGranted) {
          const tips = [
            'Status: üåª Recherche active...<br>üí° Montrez l\'image de fleur',
            'Status: üîç Scanning...<br>üí° Am√©liorez l\'√©clairage',
            'Status: üåª D√©tection...<br>üí° Tenez l\'image stable',
            'Status: üîç Recherche...<br>üí° Distance 20-50cm'
          ];
          
          let tipIndex = Math.floor(Date.now() / 3000) % tips.length;
          debugInfo.innerHTML = tips[tipIndex];
          
          // Encouragement si pas de d√©tection
          if (Date.now() - lastDetectionTime > 15000 && lastDetectionTime > 0) {
            debugInfo.innerHTML = 'Status: üí™ Continuez!<br>üí° L\'image sera d√©tect√©e';
            debugInfo.style.background = 'rgba(255, 193, 7, 0.8)';
          }
        }
      }, 2000);
      
      // Animation du guide visuel
      setInterval(() => {
        if (!targetFound) {
          detectionZone.style.transform = 'translate(-50%, -50%) scale(' + (0.95 + Math.sin(Date.now() / 1000) * 0.1) + ')';
        }
      }, 100);
    }

    // Optimisations mobiles et Mozilla
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      console.log('üì± Mobile d√©tect√© - tracking d\'image optimis√©');
      
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      });
      
      document.addEventListener('touchmove', function(e) {
        e.preventDefault();
      }, { passive: false });
    }

    // Corrections sp√©cifiques Mozilla/Firefox
    if (navigator.userAgent.includes('Firefox')) {
      console.log('ü¶ä Firefox d√©tect√© - corrections de centrage appliqu√©es');
      
      // Force le style du canvas apr√®s chargement
      window.addEventListener('load', () => {
        setTimeout(() => {
          const canvas = document.querySelector('canvas');
          if (canvas) {
            canvas.style.cssText = `
              position: absolute !important;
              top: 0 !important;
              left: 0 !important;
              width: 100% !important;
              height: 100% !important;
              transform: none !important;
              object-fit: cover !important;
            `;
          }
        }, 1000);
      });
    }

    // Gestion d'erreurs
    window.addEventListener('error', function(e) {
      console.error('Erreur AR:', e.error);
      if (debugInfo) {
        debugInfo.innerHTML = 'Status: ‚ö†Ô∏è Erreur d√©tect√©e<br>üîÑ Rechargez la page';
        debugInfo.style.background = 'rgba(244, 67, 54, 0.8)';
      }
    });

    // Log pour debug
    console.log('üåª WebAR Plant Project - Image Tracking');
    console.log('üì± URL:', window.location.href);
    console.log('üîí HTTPS:', window.location.protocol === 'https:');
    console.log('üéØ Target:', './assets/targets.mind');
    console.log('ü¶ä Firefox:', navigator.userAgent.includes('Firefox'));
  </script>
</body>
</html>