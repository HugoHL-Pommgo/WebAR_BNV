<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebAR - Plante 3D</title>
  
  <!-- AR.js - Configuration pour d√©tection plein √©cran -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    
    #startButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 999;
    }
    
    #instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      z-index: 998;
      font-size: 16px;
    }
    
    #detectionZone {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 180px;
      border: 2px solid rgba(76, 175, 80, 0.6);
      border-radius: 15px;
      z-index: 997;
      pointer-events: none;
      animation: guideAnimation 3s infinite;
    }
    
    #detectionZone::before {
      content: "";
      position: absolute;
      top: -8px;
      left: -8px;
      right: -8px;
      bottom: -8px;
      border: 1px dashed rgba(76, 175, 80, 0.3);
      border-radius: 20px;
    }
    
    #detectionZone::after {
      content: "üí° Zone sugg√©r√©e (d√©tection partout)";
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
    }
    
    @keyframes guideAnimation {
      0% { 
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1);
      }
      50% { 
        opacity: 0.8;
        transform: translate(-50%, -50%) scale(1.05);
      }
      100% { 
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    #fullDetectionArea {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 3px solid rgba(76, 175, 80, 0.2);
      z-index: 996;
      pointer-events: none;
      animation: fullAreaPulse 4s infinite;
    }
    
    @keyframes fullAreaPulse {
      0%, 100% { border-color: rgba(76, 175, 80, 0.2); }
      50% { border-color: rgba(76, 175, 80, 0.4); }
    }
    
    #debugInfo {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 995;
    }
    
    .hidden {
      display: none !important;
    }
    
    .detected {
      border-color: #FF9800 !important;
      animation: detectedGlow 1s infinite alternate !important;
    }
    
    .detected::after {
      content: "‚úÖ Marqueur d√©tect√©!" !important;
      background: rgba(255, 152, 0, 0.9) !important;
    }
    
    @keyframes detectedGlow {
      0% { box-shadow: 0 0 10px rgba(255, 152, 0, 0.6); }
      100% { box-shadow: 0 0 20px rgba(255, 152, 0, 0.9); }
    }
    
    .full-detection {
      border-color: rgba(255, 152, 0, 0.6) !important;
      animation: none !important;
    }
  </style>
</head>
<body>
  <button id="startButton" onclick="startAR()">üöÄ D√©marrer AR</button>
  
  <div id="instructions" class="hidden">
    üì± Pointez le marqueur n'importe o√π dans l'√©cran<br>
    Le cadre vert est juste un guide ‚Ä¢ Distance: 20-50cm<br>
    <a href="marker.html" style="color: #4CAF50; text-decoration: underline;">üìÑ T√©l√©charger le marqueur</a>
  </div>

  <div id="detectionZone" class="hidden"></div>
  <div id="fullDetectionArea" class="hidden"></div>

  <div id="debugInfo" class="hidden">
    Status: Initialisation...<br>
    Zone: Plein √©cran
  </div>

  <a-scene 
    id="arScene"
    class="hidden"
    embedded
    arjs="sourceType: webcam; 
          debugUIEnabled: false; 
          detectionMode: mono_and_matrix; 
          matrixCodeType: 3x3;
          maxDetectionRate: 60;
          canvasWidth: 800;
          canvasHeight: 600;
          trackingMethod: best;
          sourceWidth: 800;
          sourceHeight: 600;
          displayWidth: 800;
          displayHeight: 600;"
    renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <!-- Cam√©ra AR avec vue compl√®te -->
    <a-camera 
      rotation-reader
      look-controls-enabled="false"
      arjs-look-controls="smoothingFactor: 0.1;">
    </a-camera>
    
    <!-- Assets avec chemins GitHub Pages -->
    <a-assets>
      <a-asset-item id="plantModel" src="./assets/topfpflanze_final.glb"></a-asset-item>
    </a-assets>
    
    <!-- √âclairage optimis√© -->
    <a-light type="ambient" color="#ffffff" intensity="0.7"></a-light>
    <a-light type="directional" position="1 1 1" color="#ffffff" intensity="1.0"></a-light>
    <a-light type="point" position="0 1 0" color="#ffffff" intensity="0.5"></a-light>
    
    <!-- Marqueur avec d√©tection plein √©cran -->
    <a-marker 
      preset="hiro"
      id="hiroMarker"
      smooth="true"
      smoothCount="3"
      smoothTolerance="0.02"
      smoothThreshold="3"
      emitevents="true"
      size="1">
      
      <a-gltf-model
        id="plantModel3D"
        src="#plantModel"
        position="0 0 0"
        rotation="-90 0 0"
        scale="0.25 0.25 0.25"
        visible="true">
      </a-gltf-model>
      
      <!-- Indicateur de d√©tection -->
      <a-ring
        position="0 0.02 0"
        rotation="-90 0 0"
        radius-inner="0.6"
        radius-outer="0.8"
        color="#4CAF50"
        opacity="0.4"
        id="detectionRing"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 4000; easing: linear">
      </a-ring>
      
      <!-- Effet de particules -->
      <a-sphere
        position="0 1 0"
        radius="0.05"
        color="#4CAF50"
        opacity="0.8"
        animation="property: position; to: 0 2 0; loop: true; dur: 2000; dir: alternate; easing: easeInOutSine">
      </a-sphere>
    </a-marker>
    
  </a-scene>

  <script>
    let marker;
    let debugInfo;
    let detectionZone;
    let fullDetectionArea;
    let markerFound = false;
    let lastDetectionTime = 0;
    let cameraPermissionGranted = false;

    async function checkCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraPermissionGranted = true;
        console.log('‚úÖ Permission cam√©ra accord√©e');
        stream.getTracks().forEach(track => track.stop()); // Arr√™ter le stream de test
        return true;
      } catch (error) {
        console.error('‚ùå Erreur permission cam√©ra:', error);
        debugInfo.innerHTML = 'Status: ‚ùå Acc√®s cam√©ra refus√©<br>Cliquez sur üîí pour autoriser';
        debugInfo.style.background = 'rgba(244, 67, 54, 0.8)';
        return false;
      }
    }

    async function startAR() {
      document.getElementById('startButton').classList.add('hidden');
      document.getElementById('debugInfo').classList.remove('hidden');
      
      debugInfo = document.querySelector('#debugInfo');
      debugInfo.innerHTML = 'Status: üîç V√©rification cam√©ra...<br>Zone: Initialisation';
      
      // V√©rifier l'acc√®s cam√©ra d'abord
      const hasCamera = await checkCameraPermission();
      
      if (!hasCamera) {
        // Afficher des instructions pour autoriser la cam√©ra
        debugInfo.innerHTML = 'Status: ‚ö†Ô∏è Cam√©ra requise<br>üí° Autorisez dans les param√®tres';
        return;
      }
      
      // Si cam√©ra OK, d√©marrer l'AR
      document.getElementById('arScene').classList.remove('hidden');
      document.getElementById('instructions').classList.remove('hidden');
      document.getElementById('detectionZone').classList.remove('hidden');
      document.getElementById('fullDetectionArea').classList.remove('hidden');
      
      debugInfo.innerHTML = 'Status: üöÄ D√©marrage AR...<br>Zone: Plein √©cran';
      
      // Attendre un peu que A-Frame se charge
      setTimeout(() => {
        try {
          document.querySelector('a-scene').play();
          setupFullScreenDetection();
        } catch (error) {
          console.error('Erreur d√©marrage AR:', error);
          debugInfo.innerHTML = 'Status: ‚ùå Erreur AR<br>Rechargez la page';
        }
      }, 1000);
    }

    function setupFullScreenDetection() {
      marker = document.querySelector('#hiroMarker');
      detectionZone = document.querySelector('#detectionZone');
      fullDetectionArea = document.querySelector('#fullDetectionArea');
      
      debugInfo.innerHTML = 'Status: üîç Recherche marqueur...<br>Zone: Plein √©cran actif';
      
      if (marker) {
        // √âv√©nements de d√©tection plein √©cran
        marker.addEventListener('markerFound', function() {
          console.log('üéØ Marqueur d√©tect√©! (zone compl√®te)');
          markerFound = true;
          lastDetectionTime = Date.now();
          
          // Mise √† jour visuelle compl√®te
          detectionZone.classList.add('detected');
          fullDetectionArea.classList.add('full-detection');
          debugInfo.innerHTML = 'Status: ‚úÖ D√âTECT√â!<br>Zone: Plein √©cran actif';
          debugInfo.style.background = 'rgba(76, 175, 80, 0.8)';
          
          // Feedback tactile sur mobile
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100, 50, 200]);
          }
        });

        marker.addEventListener('markerLost', function() {
          console.log('‚ùå Marqueur perdu');
          markerFound = false;
          
          // Retour visuel normal
          detectionZone.classList.remove('detected');
          fullDetectionArea.classList.remove('full-detection');
          debugInfo.innerHTML = 'Status: üîç Recherche...<br>Zone: Plein √©cran';
          debugInfo.style.background = 'rgba(0,0,0,0.8)';
        });
      }
      
      // Mise √† jour dynamique du statut
      setInterval(() => {
        if (!markerFound && cameraPermissionGranted) {
          const currentTime = Date.now();
          const timeSinceLastDetection = currentTime - lastDetectionTime;
          
          const tips = [
            'Status: üîç Recherche active...<br>üí° Montrez le marqueur partout',
            'Status: üîç Scanning...<br>üí° Am√©liorez l\'√©clairage',
            'Status: üîç D√©tection active...<br>üí° Bougez lentement',
            'Status: üîç Recherche...<br>üí° Tenez le marqueur stable'
          ];
          
          let tipIndex = Math.floor(Date.now() / 3000) % tips.length;
          debugInfo.innerHTML = tips[tipIndex];
          
          // Encouragement si pas de d√©tection depuis longtemps
          if (timeSinceLastDetection > 10000 && lastDetectionTime > 0) {
            debugInfo.innerHTML = 'Status: üí™ Continuez!<br>üí° Le marqueur sera d√©tect√©';
            debugInfo.style.background = 'rgba(255, 193, 7, 0.8)';
          }
        }
      }, 2000);
      
      // Animation du guide visuel
      setInterval(() => {
        if (!markerFound) {
          detectionZone.style.transform = 'translate(-50%, -50%) scale(' + (0.95 + Math.sin(Date.now() / 1000) * 0.1) + ')';
        }
      }, 100);
    }

    // Optimisations sp√©cifiques mobile
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      console.log('üì± Mobile d√©tect√© - d√©tection plein √©cran optimis√©e');
      
      // Pr√©venir le zoom sur mobile
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      });
      
      // Emp√™cher le scroll
      document.addEventListener('touchmove', function(e) {
        e.preventDefault();
      }, { passive: false });
    }

    // Gestion des erreurs avec red√©marrage automatique
    window.addEventListener('error', function(e) {
      console.error('Erreur AR:', e.error);
      if (debugInfo) {
        debugInfo.innerHTML = 'Status: ‚ö†Ô∏è Erreur d√©tect√©e<br>üîÑ Rechargez la page';
        debugInfo.style.background = 'rgba(244, 67, 54, 0.8)';
      }
    });

    // Log pour debug
    console.log('üå± WebAR Plant Project - Version GitHub Pages');
    console.log('üì± URL:', window.location.href);
    console.log('üîí HTTPS:', window.location.protocol === 'https:');
  </script>
</body>
</html>